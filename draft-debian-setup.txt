#!/bin/bash

# ~/.config/weston.ini

[core]
# https://manpages.debian.org/trixie/weston/weston.ini.5.en.html
# Enables support for X11 applications
# xwayland=true
# Use the Kiosk shell to force the nested app to fill the screen
shell=kiosk-shell.so
# force wayland backend
backend=wayland
# disable screen blanking
idle-time=0

[libinput]
# Enables tap to click on touchpad devices
enable-tap=true
# Enables tap and drag on touchpad devices
tap-and-drag=true
# disable other devices while typing on keyboard
disable-while-typing=false
# clicking both left and right buttons together simulates middle click
middle-button-emulation=false
# enable touchscreen calibrator interface
touchscreen_calibrator=false

[shell]
# set background color to opaque black
background-color=0xff000000
# Enables screen locking (Boolean)
locking=false
# Opening new windows animation
animation=none
# Closing windows animation
close-animation=none
# Effect used by desktop-shell when starting up
startup-animation=none
# Effect used with focused vs unfocused windows
focus-animation=dim-layer
# Weston quits when the Ctrl-Alt-Backspace key combination is pressed
allow-zap=true
# Modifier key for bindings - see https://manpages.debian.org/trixie/weston/weston-bindings.7.en.html
binding-modifier=alt
# Set the cursor theme
# cursor-theme=
# Set the cursor size
cursor-size=48

[keyboard]
keymap_model=pc105
keymap_layout=gb
keymap_variant=extd

# Set up virtual screen on Weston, in the background (final ampersand)

weston --socket=weston > /dev/null 2>&1 &

ls /run/user/$(id -u)/weston

# Run weston with log output to terminal for troubleshooting
# weston --socket=weston
# End weston session
# pkill -f "weston --socket=weston"

# Run kde-plasma in weston

WAYLAND_DISPLAY=weston \
GALLIUM_DRIVER=d3d12 \
MESA_D3D12_DEFAULT_ADAPTER_NAME=NVIDIA \
dbus-run-session startplasma-wayland > /dev/null 2>&1 &





# Add google dot white cursor
https://github.com/ful1e5/Google_Cursor/releases/latest





# Packages to build ananicy-cpp

sudo apt update && sudo apt install -y \
build-essential \
cmake \
libsystemd-dev \
pkg-config \
debhelper

# get latest tagged version and corresponding commit

ananicy_version=$(lynx -dump -nonumbers https://gitlab.com/ananicy-cpp/ananicy-\
cpp/-/tags | grep -oP 'v[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)
echo -e "> ananicy_version=${ananicy_version}"

ananicy_commit=$(lynx -dump -nonumbers https://gitlab.com/ananicy-cpp/ananicy-\
cpp/-/tags | grep -C 1 -P 'v[0-9]+\.[0-9]+\.[0-9]+' | head -n 3 | tail -n 1 | \
grep -oP '\b[a-z0-9]{8}\b')
echo -e "> ananicy_commit=${ananicy_commit}"

# Make folder(s) if they don't exist

echo -e "$ mkdir -p ~/git/ananicy-cpp/ananicy-cpp/${ananicy_version}"
mkdir -p "${HOME}/git/ananicy-cpp/ananicy-cpp/${ananicy_version}"

# Navigate to working directory

echo -e "$ cd ~/git/ananicy-cpp/ananicy-cpp"
cd "${HOME}/git/ananicy-cpp/ananicy-cpp" 2> /dev/null \
|| { echo -e "${redbold}> Failed to change directory, exiting${normal}\n"\
; exit 101; }

# Clone project

echo -e "$ git clone https://gitlab.com/ananicy-cpp/ananicy-cpp.git ."
git clone https://gitlab.com/ananicy-cpp/ananicy-cpp.git .

# Checkout the specific commit
echo -e "Checking out commit: $ananicy_commit"
git checkout "$ananicy_commit"

# Prepare the build environment
# ananicy-cpp uses a standard CMake build process
cd ${ananicy_version}
mkdir build && cd build

# Compile
cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)

# Build the Debian package
# We use 'cpack' which is integrated with CMake to generate the .deb
cpack -G DEB

echo "Build complete. Your .deb package is located in:"
echo "$(pwd)"

# TO-DO: Install deb package

if ! -f /etc/ananicy.d/gamescope.rules; then
echo '{"name": "gamescope", "nice": -20, "ioclass": "realtime"}' | \
sudo tee /etc/ananicy.d/gamescope.rules
fi

sudo systemctl stop ananicy-cpp

sudo systemctl enable --now ananicy-cpp

systemctl status ananicy-cpp

# Set dir for user runtime files (sockets, named pipes, temp locks, etc.)
export XDG_RUNTIME_DIR=/run/user/$(id -u)  && \
# Configure mesa
export GALLIUM_DRIVER=d3d12 && \
export MESA_D3D12_DEFAULT_ADAPTER_NAME=NVIDIA
export VK_DRIVER_FILES=/usr/share/vulkan/icd.d/lvp_icd.json && \
# Direct session to display through WSLg
export WAYLAND_DISPLAY=wayland-0 && \
# Within kde-plasma, use Wayland rather than an X-Server
export QT_QPA_PLATFORM=wayland && \
# Run kde-plasma with a parent dbus session bus
# Run kde-plasma within gamescope as virtual display we can configure
dbus-run-session gamescope -f -w 2400 -h 1600 -r 120.000191 --framerate-limit 120 --backend wayland --expose-wayland -- startplasma-wayland

# Symlink from runtime dir tp WSLg Wayland socket
ln -sf /mnt/wslg/runtime-dir/wayland-0* "$XDG_RUNTIME_DIR/" && \





sudo apt install -y /
gnome-core /
evince- /
papers /
alacritty /
gnome-terminal- /
gnome-console- /
ptyxis /
totem /
showtime /
firefox-esr- /
firefox- /
chromium /
epiphany-browser /
seahorse

# https://gist.github.com/tdcosta100
# https://gist.github.com/onomatopellan/c5220c0efddaff69aaff77cca80b7b8e?permalink_comment_id=5680043#gistcomment-5680043
# https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/10/html/administering_rhel_by_using_the_gnome_desktop_environment/remotely-accessing-the-desktop#connecting-to-a-remote-desktop-session-on-a-headless-server-for-a-single-user
# https://discourse.gnome.org/t/with-ssh-only-access-how-do-you-configure-headless-gnome-remote-desktop/24998
# https://std.rocks/gnulinux_rdp_remotedesktop.html

sudo apt install gnome-remote-desktop freerdp3-wayland

mkdir -p ~/.local/share/gnome-remote-desktop

export GRDCERTDIR=~/.local/share/gnome-remote-desktop

openssl genrsa -out ${GRDCERTDIR}/tls.key 4096

# Use the ubuntu-live X509 distinguished name to avoid invalid certificate errors

openssl req -new -key ${GRDCERTDIR}/tls.key -out ${GRDCERTDIR}/tls.csr -subj "/C=DE/ST=Private/L=Home/O=Family/OU=IT Department/CN=ubuntu-live"

openssl x509 -req -days 100000 -signkey ${GRDCERTDIR}/tls.key -in ${GRDCERTDIR}/tls.csr -out ${GRDCERTDIR}/tls.crt

grdctl --headless rdp set-tls-key ~/.local/share/gnome-remote-desktop/tls.key

Unused commands:
openssl req -new -key ${GRDCERTDIR}/tls.key -out ${GRDCERTDIR}/tls.csr -subj "/C=AU/ST=QLD/L=Locality/O=OrgName/OU=OrgUnit/CN=WSL2-rdp-login"
sudo -u gnome-remote-desktop winpr-makecert3 -silent -rdp -path ~gnome-remote-desktop rdp-tls

DESKTOP_SESSION=default \
GDMSESSION=default \
GNOME_SHELL_SESSION_MODE=default \
GTK_IM_MODULE=ibus \
GTK_MODULES=gail:atk-bridge \
IM_CONFIG_CHECK_ENV=1 \
IM_CONFIG_PHASE=1 \
QT_ACCESSIBILITY=1 \
QT_IM_MODULE=ibus \
XDG_CURRENT_DESKTOP=default:GNOME \
XDG_DATA_DIRS=/usr/share/default:$XDG_DATA_DIRS \
XDG_SESSION_TYPE=wayland \
XMODIFIERS=@im=ibus \
MUTTER_DEBUG_DUMMY_MODE_SPECS=2368x1480 \
gnome-session

D3F3JM6D24303H7:3389

Try again from scratch (no mucking about with polkit this time)
Enable only remote desktop and not screensharing (and not both)

If grd fails, try xrdp

command for Windows username:
WIN_USERNAME="$(powershell.exe -NoProfile -NonInteractive -Command "\$Env:UserName")"
install net-tools, then:
WIN_IP="$(route -n | grep "^0\.0\.0\.0" | awk '{print $2}')"

# https://avivarma1.medium.com/setting-up-debian-on-wsl2-with-systemd-fb4831dd7b82

wsl.conf settings:

cat <<EOF > /etc/wsl.conf
# https://devblogs.microsoft.com/commandline/automatically-configuring-wsl/
# https://learn.microsoft.com/en-us/windows/wsl/wsl-config

# Use systemd in WSL2
[boot]
systemd=true

# Enable WSL support for interop process like launching Windows apps and adding path variables
[interop]
appendWindowsPath=true

# Enable Automatic mounting of Windows drive(s) when the distribution is launched
[automount]
enabled=true

# Enable access to the Windows GPU via para-virtualization
[gpu]
enabled=true

# Separate WSL network settings from Windows host
[network]
hostname=DebWSL
generateHosts=false
generateResolvConf=false

EOF

cat /etc/wsl.conf

Gone remote desktop:
https://discourse.gnome.org/t/with-ssh-only-access-how-do-you-configure-headless-gnome-remote-desktop/24998/25
https://wiki.archlinux.org/title/Linux_console/Keyboard_configuration

KDE rather than GNOME route:

To load KDE nested, try:
dbus-run-session startplasma-wayland
https://www.reddit.com/r/kde/comments/1koedbi/is_it_possible_to_start_a_nested_plasma_desktop/

KDE install command:

sudo apt install -y \
dolphin \
kdialog \
keditbookmarks \
kfind \
konqueror \
konq-plugins \
imagemagick \
alacritty \
kwrite \
plasma-desktop \
plasma-desktop-doc \
plasma-workspace \
plasma-workspace-doc \
kwalletmanager  \
plasma-dataengines-addons \
plasma-pa \
kmix- \
plasma-runners-addons \
plasma-wallpapers-addons \
plasma-widgets-addons \
polkit-kde-agent-1 \
plasma-nm \
webext-plasma-browser-integration \
firefox-esr- \
chromium \
systemsettings \
kdeadmin \
kdegames \
kajongg \
kdegraphics \
kdegraphics-thumbnailers \
svgpart \
kdemultimedia \
ffmpegthumbs \
kasts \
kde-spectacle

For GPU acceleration of WSL2, need these environment variables:
GALLIUM_DRIVER=d3d12 MESA_D3D12_DEFAULT_ADAPTER_NAME=NVIDIA glxinfo -B
export GALLIUM_DRIVER=d3d12
export MESA_D3D12_DEFAULT_ADAPTER_NAME=NVIDIA

echo -e "vgem\n" | sudo tee /etc/modules-load.d/vgem.conf
cat /etc/modules-load.d/vgem.conf
sudo modprobe vgem

lsmod | grep vgem
ls -l /dev/dri/card*

export GALLIUM_DRIVER=d3d12
export MESA_D3D12_DEFAULT_ADAPTER_NAME=NVIDIA
glxinfo -B

See more detail here:
https://gist.github.com/lzlrd/0d9b757d2122f551794fd00c7f0752d6

Sunshine server and moonlight client:
https://docs.lizardbyte.dev/projects/sunshine/latest/
https://github.com/LizardByte/Sunshine?tab=readme-ov-file#sunshine
https://github.com/moonlight-stream/moonlight-qt?tab=readme-ov-file#moonlight-pc
...with a forced EDID to set monitor and resolution



...or maybe use gamescope instead:

(1) Add unstable repo with Pin-Priority favouring Stable > Testing > Unstable
https://jaqque.sbih.org/kplug/apt-pinning.html
DONE

(2) Install Unstable gamescope but with dependencies from Stable:
sudo apt install gamescope/sid
CONFIRMED WORKING

(3) Run KDE plasma nested in gamescope

https://gist.github.com/davidedmundson/8e1732b2c8b539fd3e6ab41a65bcab74
https://gist.github.com/lucsoft/40c929537e083f1984d4dedd393eae80

https://github.com/ValveSoftware/gamescope/issues/1755
https://gist.github.com/fishman/048ae2de25b208443e74a2978671164f

Need KDE without:
"Wayland to X recording bridge" "Xwayland video bridge"
sudo apt purge xwaylandvideobridge



https://stackoverflow.com/questions/69550071/how-to-create-a-linux-gui-app-short-cut-for-wsl2-on-windows10
https://github.com/barrett101/Intune-Desktop-Shortcut-with-embedded-icon-in-script



Avenues for scaling plasma 6 to 125%

## --- Scaling subsection ---
## Apply DPI font scaling at ( 96 * 1.25 = ) 120
QT_WAYLAND_FORCE_DPI=120
## Disable both highdpi scaling & auto-scaling to prevent double-scaling issues
QT_ENABLE_HIGHDPI_SCALING=0
QT_AUTO_SCREEN_SCALE_FACTOR=0

kdeglobals file, kscreen section, scalefactor and screenscalefactor configuration keys
kcmfonts file, general section, forceFontDPI and dontChangeAASettings configuration keys < THIS IS BEST

For firefox, you may need to set widget.wayland.fractional-scale.enabled to true in about:config.
For chrome/chromium, see https://wiki.archlinux.org/title/HiDPI#Chromium_/_Google_Chrome



TO-DO:
  - kwin_xwl: /tmp/.X11-unix has no sticky bit on
  - Disable kwin_screencast
  - Unpin KE Plasma Taskbar apps
  - Remove Show Desktop button
  - Share clipboards
  - Connect WSL Pipewire audio to KDE Plasma session
  - Still haven't succeeded with 125% screen scaling



Overall, this project is to build two bash scripts with the below functionality:

Bash script `falkon-captive-portal.sh`, which on Debian Trixie, with a KDE desktop environment, performs the following:

(1) Checks for everything needed for use later in the script with `if ! command -v ${exampletool} &> /dev/null; then ...`
(2) Establish a chroot or similar as a temporary package building environment that is cleared up at the end of the script
(3) Get the latest tagged version of Falkon as per https://invent.kde.org/network/falkon/-/tags
(4) Apply patches to Falkon as follows:
  (4.1) Make the address bar always read only
  (4.2) Hard-code that this Falkon browser variant opens all new tabs to http://networkcheck.kde.org/ (note not https, and note the URL may be redirected later - e.g. in a captive portal scenario - and you can see that occur in the read-only address bar, but no UI interaction with the address bar is possible any more)
  (4.3) In Falkon settings, make the element where you would otherwise be able to change the homepage(s), read-only.
(5) Rename the package / application from 'falkon' to 'captiveportalonly'
(6) Build and debian package 'captiveportalonly', so that it is as similar as possible to https://packages.debian.org/trixie/falkon#pdeps.  Make sure we build only with Debian stable (Trixie) package dependencies.  Please remove libsvtav1enc0 as a recommended package for 'captiveportalonly'.
(7) Clean up, so that the only thing left from script operation, is `captiveportalonly.deb` in `$HOME`.

Bash script `captive-portal-systemd-service.sh`, that configureas a systemd service that runs every time any network connection changes.  This will execute logic along the lines of the following:

`portaltest=$(lynx -dump http://networkcheck.kde.org | cut -c 1- | grep -o "OK")`
`if [[ "$portaltest" != "OK" ]]; then captiveportalonly fi`

i.e. run the captiveportalonly app if lynx cannot get OK from the KDE network check web page.

All outputs will be published to https://github.com/phil-gg/captiveportalonly under an MIT0 licence.

Separately (out of scope for this project), I will be configuring networking on the machine for lynx and 'captiveportalonly' to use the raw network connection(s) on the machine and the DHCP provided DNS server, while everything else on the machine must use a VPN tunnel.  I will put these further developments into https://github.com/phil-gg/captiveportalonly at some unspecified later date.

I note that Arcâ€™s average developer rate is USD 60-100+ per hour.  For this initial project, if your rate was USD 60, my budget for all build and test for the above scope, extends to 3 hours.  If you charge more per hour, you would need to be correspondingly quicker to be in budget.

